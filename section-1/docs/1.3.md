# Simple Express Application

## Overview

In this hands-on exercise, we'll build a simple Express.js application from scratch to understand the core properties of Express including routing, request/response objects, middleware, and CORS.

## Learning Objectives

- Set up a basic Express server
- Understand Express routing methods (GET, POST, PUT, DELETE)
- Work with request and response objects
- Implement middleware and understand next()
- Use Express Router
- Handle CORS

## Exercise: Building a Simple Task Manager API

Let's build a simple task management API to demonstrate Express.js fundamentals.

### Step 1: Project Setup

First, create a new project directory and initialize it:

```bash
mkdir simple-express-app
cd simple-express-app
npm init -y
```

Install the required dependencies:

```bash
npm install express cors
npm install -D @types/express @types/node typescript ts-node nodemon
```

Create a TypeScript configuration:

```bash
npx tsc --init
```

Update `tsconfig.json`:

```json
{
  "compilerOptions": {
    "target": "es2020",
    "module": "commonjs",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

Update `package.json` scripts:

```json
{
  "scripts": {
    "start": "node dist/app.js",
    "dev": "nodemon src/app.ts",
    "build": "tsc"
  }
}
```

### Step 2: Basic Express Server

Create `src/app.ts`:

```typescript
import express, { Request, Response, NextFunction } from "express";
import cors from "cors";

// Create Express application
const app = express();
const PORT = process.env.PORT || 3000;

// Global Middleware
app.use(cors()); // Enable CORS for all routes
app.use(express.json()); // Parse JSON bodies
app.use(express.urlencoded({ extended: true })); // Parse URL-encoded bodies

// Simple in-memory data store
interface Task {
  id: number;
  title: string;
  description: string;
  completed: boolean;
  createdAt: Date;
}

let tasks: Task[] = [
  {
    id: 1,
    title: "Learn Express.js",
    description: "Build a simple API with Express",
    completed: false,
    createdAt: new Date(),
  },
  {
    id: 2,
    title: "Setup TypeScript",
    description: "Configure TypeScript for the project",
    completed: true,
    createdAt: new Date(),
  },
];

let nextId = 3;

// Root route
app.get("/", (req: Request, res: Response) => {
  res.json({
    message: "Welcome to Simple Task Manager API",
    version: "1.0.0",
    endpoints: {
      tasks: "/api/tasks",
      health: "/health",
    },
  });
});

// Health check endpoint
app.get("/health", (req: Request, res: Response) => {
  res.json({
    status: "OK",
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
  });
});

// Start server
app.listen(PORT, () => {
  console.log(`üöÄ Server running on http://localhost:${PORT}`);
  console.log(`üìö API Documentation: http://localhost:${PORT}/`);
});
```

### Step 3: Understanding Express Routing Methods

Add task-related routes to demonstrate different HTTP methods:

```typescript
// Add this after the health check endpoint

// GET - Retrieve all tasks
app.get("/api/tasks", (req: Request, res: Response) => {
  console.log("üì• GET /api/tasks - Request received");
  console.log("Query parameters:", req.query);

  // Optional filtering by completed status
  const { completed } = req.query;
  let filteredTasks = tasks;

  if (completed !== undefined) {
    const isCompleted = completed === "true";
    filteredTasks = tasks.filter((task) => task.completed === isCompleted);
  }

  res.json({
    success: true,
    count: filteredTasks.length,
    data: filteredTasks,
  });
});

// GET - Retrieve a specific task by ID
app.get("/api/tasks/:id", (req: Request, res: Response) => {
  console.log("üì• GET /api/tasks/:id - Request received");
  console.log("Route parameters:", req.params);

  const taskId = parseInt(req.params.id);
  const task = tasks.find((t) => t.id === taskId);

  if (!task) {
    return res.status(404).json({
      success: false,
      message: "Task not found",
    });
  }

  res.json({
    success: true,
    data: task,
  });
});

// POST - Create a new task
app.post("/api/tasks", (req: Request, res: Response) => {
  console.log("üì• POST /api/tasks - Request received");
  console.log("Request body:", req.body);
  console.log("Request headers:", req.headers);

  const { title, description } = req.body;

  // Basic validation
  if (!title || !description) {
    return res.status(400).json({
      success: false,
      message: "Title and description are required",
    });
  }

  const newTask: Task = {
    id: nextId++,
    title,
    description,
    completed: false,
    createdAt: new Date(),
  };

  tasks.push(newTask);

  // Set response status and return created task
  res.status(201).json({
    success: true,
    message: "Task created successfully",
    data: newTask,
  });
});

// PUT - Update an existing task
app.put("/api/tasks/:id", (req: Request, res: Response) => {
  console.log("üì• PUT /api/tasks/:id - Request received");
  console.log("Route parameters:", req.params);
  console.log("Request body:", req.body);

  const taskId = parseInt(req.params.id);
  const taskIndex = tasks.findIndex((t) => t.id === taskId);

  if (taskIndex === -1) {
    return res.status(404).json({
      success: false,
      message: "Task not found",
    });
  }

  const { title, description, completed } = req.body;

  // Update task properties
  if (title !== undefined) tasks[taskIndex].title = title;
  if (description !== undefined) tasks[taskIndex].description = description;
  if (completed !== undefined) tasks[taskIndex].completed = completed;

  res.json({
    success: true,
    message: "Task updated successfully",
    data: tasks[taskIndex],
  });
});

// DELETE - Remove a task
app.delete("/api/tasks/:id", (req: Request, res: Response) => {
  console.log("üì• DELETE /api/tasks/:id - Request received");
  console.log("Route parameters:", req.params);

  const taskId = parseInt(req.params.id);
  const taskIndex = tasks.findIndex((t) => t.id === taskId);

  if (taskIndex === -1) {
    return res.status(404).json({
      success: false,
      message: "Task not found",
    });
  }

  const deletedTask = tasks.splice(taskIndex, 1)[0];

  res.json({
    success: true,
    message: "Task deleted successfully",
    data: deletedTask,
  });
});
```

### Step 4: Working with Request and Response Objects

Let's add a route that demonstrates various properties of the request and response objects:

```typescript
// Add this route to explore request/response objects
app.get("/api/debug/request", (req: Request, res: Response) => {
  console.log("üîç Debug endpoint accessed");

  // Request object properties
  const requestInfo = {
    // HTTP Method
    method: req.method,

    // URL components
    originalUrl: req.originalUrl,
    path: req.path,
    baseUrl: req.baseUrl,

    // Parameters
    params: req.params,
    query: req.query,

    // Headers
    headers: req.headers,

    // Body (if any)
    body: req.body,

    // Client information
    ip: req.ip,
    ips: req.ips,

    // Additional properties
    protocol: req.protocol,
    secure: req.secure,
    hostname: req.hostname,
    subdomains: req.subdomains,

    // Custom properties (we can add our own)
    timestamp: new Date().toISOString(),
  };

  // Response object methods
  res
    .status(200) // Set status code
    .set("X-Custom-Header", "Express-Demo") // Set custom header
    .cookie("demo-cookie", "express-learning", {
      maxAge: 3600000, // 1 hour
      httpOnly: true,
    }) // Set cookie
    .json({
      message: "Request debugging information",
      requestInfo,
    });
});
```

### Step 5: Implementing Middleware

Add custom middleware to understand the middleware chain:

```typescript
// Add these middleware functions before your routes

// Custom logging middleware
const requestLogger = (req: Request, res: Response, next: NextFunction) => {
  const timestamp = new Date().toISOString();
  const method = req.method;
  const url = req.originalUrl;
  const userAgent = req.headers["user-agent"];

  console.log(`[${timestamp}] ${method} ${url} - User-Agent: ${userAgent}`);

  // Continue to next middleware/route handler
  next();
};

// Custom validation middleware for task creation
const validateTaskInput = (req: Request, res: Response, next: NextFunction) => {
  console.log("üîç Validating task input...");

  if (req.method === "POST" && req.path === "/api/tasks") {
    const { title, description } = req.body;

    if (!title || title.trim().length < 3) {
      return res.status(400).json({
        success: false,
        message: "Title must be at least 3 characters long",
      });
    }

    if (!description || description.trim().length < 10) {
      return res.status(400).json({
        success: false,
        message: "Description must be at least 10 characters long",
      });
    }
  }

  next();
};

// Performance monitoring middleware
const performanceMonitor = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const startTime = Date.now();

  // Override res.end to calculate response time
  const originalEnd = res.end;
  res.end = function (...args: any[]) {
    const duration = Date.now() - startTime;
    console.log(`‚è±Ô∏è  ${req.method} ${req.path} completed in ${duration}ms`);

    // Call original end method
    originalEnd.apply(this, args);
  };

  next();
};

// Apply middleware globally
app.use(requestLogger);
app.use(performanceMonitor);

// Apply middleware to specific routes
app.use("/api/tasks", validateTaskInput);
```

### Step 6: Using Express Router

Create a separate router for better organization:

```typescript
// Create a separate file: src/routes/taskRoutes.ts
import { Router, Request, Response } from "express";

const taskRouter = Router();

// All routes here will be prefixed with /api/tasks
taskRouter.get("/", (req: Request, res: Response) => {
  // Same logic as before
  console.log("üì• GET /api/tasks - From Router");
  // ... rest of the GET logic
});

taskRouter.get("/:id", (req: Request, res: Response) => {
  // Same logic as before
  console.log("üì• GET /api/tasks/:id - From Router");
  // ... rest of the GET by ID logic
});

taskRouter.post("/", (req: Request, res: Response) => {
  // Same logic as before
  console.log("üì• POST /api/tasks - From Router");
  // ... rest of the POST logic
});

taskRouter.put("/:id", (req: Request, res: Response) => {
  // Same logic as before
  console.log("üì• PUT /api/tasks/:id - From Router");
  // ... rest of the PUT logic
});

taskRouter.delete("/:id", (req: Request, res: Response) => {
  // Same logic as before
  console.log("üì• DELETE /api/tasks/:id - From Router");
  // ... rest of the DELETE logic
});

export default taskRouter;
```

Update `app.ts` to use the router:

```typescript
// Import the router
import taskRouter from "./routes/taskRoutes";

// Use the router (replace the individual task routes)
app.use("/api/tasks", taskRouter);
```

### Step 7: Advanced CORS Configuration

Replace the simple CORS configuration with a more detailed one:

```typescript
// Advanced CORS configuration
const corsOptions = {
  origin: function (origin: string | undefined, callback: Function) {
    // List of allowed origins
    const allowedOrigins = [
      "http://localhost:3000",
      "http://localhost:3001",
      "http://localhost:8080",
      "https://myapp.com",
    ];

    // Allow requests with no origin (mobile apps, postman, etc.)
    if (!origin) return callback(null, true);

    if (allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true);
    } else {
      console.log(`‚ùå CORS blocked origin: ${origin}`);
      callback(new Error("Not allowed by CORS"));
    }
  },
  credentials: true, // Allow cookies
  methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
  allowedHeaders: ["Content-Type", "Authorization", "X-Requested-With"],
  optionsSuccessStatus: 200, // For legacy browser support
};

app.use(cors(corsOptions));
```

### Step 8: Error Handling

Add proper error handling:

```typescript
// Error handling middleware (add at the end, before app.listen)
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
  console.error("‚ùå Error occurred:", err.message);
  console.error(err.stack);

  // CORS error
  if (err.message.includes("CORS")) {
    return res.status(403).json({
      success: false,
      message: "CORS policy violation",
      error: "Origin not allowed",
    });
  }

  // Default error
  res.status(500).json({
    success: false,
    message: "Internal server error",
    error:
      process.env.NODE_ENV === "development"
        ? err.message
        : "Something went wrong",
  });
});

// Handle 404 routes
app.use("*", (req: Request, res: Response) => {
  res.status(404).json({
    success: false,
    message: "Route not found",
    availableEndpoints: [
      "GET /",
      "GET /health",
      "GET /api/tasks",
      "GET /api/tasks/:id",
      "POST /api/tasks",
      "PUT /api/tasks/:id",
      "DELETE /api/tasks/:id",
    ],
  });
});
```

### Step 9: Testing Your Application

Run the application:

```bash
npm run dev
```

Test with curl commands or a tool like Postman:

```bash
# Get all tasks
curl http://localhost:3000/api/tasks

# Create a new task
curl -X POST http://localhost:3000/api/tasks \
  -H "Content-Type: application/json" \
  -d '{"title": "Test Task", "description": "This is a test task description"}'

# Get a specific task
curl http://localhost:3000/api/tasks/1

# Update a task
curl -X PUT http://localhost:3000/api/tasks/1 \
  -H "Content-Type: application/json" \
  -d '{"completed": true}'

# Delete a task
curl -X DELETE http://localhost:3000/api/tasks/1

# Test filtering
curl "http://localhost:3000/api/tasks?completed=true"

# Test debug endpoint
curl http://localhost:3000/api/debug/request
```

## Key Express.js Concepts Demonstrated

### 1. Express Application Object

```typescript
const app = express(); // Creates Express application
app.use(); // Application-level middleware
app.listen(); // Starts server
```

### 2. HTTP Methods

- `app.get()` - Handle GET requests
- `app.post()` - Handle POST requests
- `app.put()` - Handle PUT requests
- `app.delete()` - Handle DELETE requests

### 3. Request Object Properties

- `req.params` - Route parameters
- `req.query` - Query string parameters
- `req.body` - Request body (with middleware)
- `req.headers` - Request headers
- `req.method` - HTTP method
- `req.path` - URL path

### 4. Response Object Methods

- `res.json()` - Send JSON response
- `res.status()` - Set status code
- `res.set()` - Set response headers
- `res.cookie()` - Set cookies
- `res.send()` - Send response

### 5. Middleware Chain

- Middleware functions execute in order
- `next()` passes control to next middleware
- Error middleware has 4 parameters

### 6. Router Object

- `Router()` creates modular route handlers
- Mount routers with `app.use()`
- Organize routes by feature

### 7. CORS Handling

- Enable cross-origin requests
- Configure allowed origins, methods, headers
- Handle preflight requests

## Complete File Structure

Your final project structure should look like:

```
simple-express-app/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.ts
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ       ‚îî‚îÄ‚îÄ taskRoutes.ts
‚îú‚îÄ‚îÄ dist/ (generated)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ node_modules/
```

This simple Express application demonstrates all the core concepts you need to understand before building more complex applications!

---

## References and Resources

### Express.js Core

- [Express.js Official Documentation](https://expressjs.com/)
- [Express.js API Reference](https://expressjs.com/en/4x/api.html)
- [Express.js Routing Guide](https://expressjs.com/en/guide/routing.html)
- [Express.js Middleware Guide](https://expressjs.com/en/guide/using-middleware.html)

### HTTP and Web Fundamentals

- [HTTP Methods - MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods)
- [HTTP Status Codes](https://httpstatuses.com/)
- [Understanding CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)

### TypeScript with Express

- [TypeScript Express Tutorial](https://blog.logrocket.com/how-to-set-up-node-typescript-express/)
- [Express TypeScript Definitions](https://www.npmjs.com/package/@types/express)

### Testing and Development Tools

- [Postman Documentation](https://learning.postman.com/)
- [curl Tutorial](https://curl.se/docs/manual.html)
- [Nodemon Documentation](https://nodemon.io/)
